<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title>게시글 상세보기</title>
    <link rel="stylesheet" href="https://bootswatch.com/5/cosmo/bootstrap.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
        }
        /* 게시글 본문 이미지 및 비디오 크기 조절 */
        .board-content img,
        .board-content figure,
        .board-content video {
            max-width: 100%;
            height: auto;
            max-height: 600px;
        }
    </style>
</head>
<body>
    <div th:replace="~{header :: header}"></div>
        <div th:replace="~{menu :: menu}"></div>
    <main class="container my-5" style="max-width:700px;">
        <h1 class="mb-4" th:text="${board.boardTitle}">제목</h1>
        <div class="mb-2 text-muted">
            <a th:if="${board.memberName != null}" th:href="@{/member/profile/{memberId}(memberId=${board.memberId})}" th:text="${board.memberName}" class="text-decoration-none"></a>
            <span th:if="${board.memberName == null}">탈퇴회원</span> |
            <span th:text="${#temporals.format(board.createdDate, 'yyyy-MM-dd HH:mm:ss')}">작성일</span> |
            <span th:text="'조회수: ' + ${board.hits}"></span>
        </div>
        <hr>
        <div class="mb-5 board-content" th:utext="${board.boardContent}">내용</div>

        <!-- 첨부파일 영역 추가 -->
        <div class="mb-4" th:if="${not #lists.isEmpty(board.files)}">
            <hr>
            <h5><i class="bi bi-paperclip"></i> 첨부파일</h5>
            <div class="card">
                <ul class="list-group list-group-flush">
                    <li class="list-group-item" th:each="file : ${board.files}">
                        <div th:if="${#strings.startsWith(file.contentType, 'image/')}">
                            <img th:src="@{/uploads/{savedName}(savedName=${file.savedName})}" th:alt="${file.originalName}" class="img-fluid rounded mb-2" style="max-height: 300px;">
                            <div class="mt-2">
                                <a th:href="@{/board/download/{fileId}(fileId=${file.fileId})}" th:text="${file.originalName}" class="text-decoration-none"></a>
                                <span class="text-muted small ms-2" th:text="'(' + ${file.fileSize / 1024} + ' KB)'"></span>
                            </div>
                        </div>
                        <div th:unless="${#strings.startsWith(file.contentType, 'image/')}">
                            <a th:href="@{/board/download/{fileId}(fileId=${file.fileId})}" th:text="${file.originalName}" class="text-decoration-none"></a>
                            <span class="text-muted small ms-2" th:text="'(' + ${file.fileSize / 1024} + ' KB)'"></span>
                        </div>
                    </li>
                </ul>
            </div>
        </div>

        <div class="d-flex gap-2">
            <a th:href="@{/board/list}" class="btn btn-secondary">목록</a>
            <a th:href="@{'/board/edit/' + ${board.boardNum}}" class="btn btn-warning"
               th:if="${#authorization.expression('isAuthenticated()') and board.memberId != null and #authentication.name == board.memberId}">수정</a>
            <form th:action="@{'/board/delete/' + ${board.boardNum}}" method="post" style="display:inline;"
                  th:if="${#authorization.expression('isAuthenticated()') and ((board.memberId != null and #authentication.name == board.memberId) or #authorization.expression('hasRole(''ADMIN'')'))}">
                <button type="submit" class="btn btn-danger" onclick="return confirm('정말 삭제하시겠습니까?');">삭제</button>
            </form>
            <button id="reportBtn" class="btn btn-outline-danger" th:if="${#authorization.expression('isAuthenticated()')}">신고</button>
        </div>

        <hr class="my-4">

        <!-- 댓글 영역 -->
        <div class="comments-section">
            <h4>댓글</h4>
            <!-- 댓글 작성 폼 -->
            <div th:if="${#authorization.expression('isAuthenticated()')}">
                <!-- 계정이 활성화된 경우 -->
                <form id="comment-form" class="mb-4" th:if="${#authorization.expression('principal.enabled')}">
                    <div class="input-group">
                        <textarea id="comment-content" class="form-control" rows="3" placeholder="댓글을 입력하세요..."></textarea>
                        <button type="submit" class="btn btn-primary">등록</button>
                    </div>
                </form>
                <!-- 계정이 비활성화된 경우 -->
                <div class="mb-4" th:if="${#authorization.expression('!principal.enabled')}">
                    <div class="input-group">
                        <textarea class="form-control" rows="3" placeholder="계정이 비활성화되어 댓글을 작성할 수 없습니다." disabled></textarea>
                        <button type="button" class="btn btn-primary" disabled>등록</button>
                    </div>
                </div>
            </div>
            <!-- 댓글 목록 -->
            <div id="comments-list"></div>
        </div>
    </main>
    <div th:replace="~{footer :: footer}"></div>

    <script th:inline="javascript">
        /*<![CDATA[*/
        const boardNum = /*[[${board.boardNum}]]*/ 0;
        const currentMemberId = /*[[${#authentication.name}]]*/ null;
        let originalCommentContent = {};

        document.addEventListener('DOMContentLoaded', function () {
            loadComments();

            const commentForm = document.getElementById('comment-form');
            if (commentForm) {
                commentForm.addEventListener('submit', function (e) {
                    e.preventDefault();
                    const content = document.getElementById('comment-content').value;
                    if (!content.trim()) {
                        alert('댓글 내용을 입력하세요.');
                        return;
                    }
                    createComment(content);
                });
            }
            
            const reportBtn = document.getElementById('reportBtn');
            if(reportBtn) {
                reportBtn.addEventListener('click', function() {
                    if(confirm('이 게시글을 신고하시겠습니까?')) {
                        reportBoard();
                    }
                });
            }
        });
        
        async function reportBoard() {
            try {
                const response = await fetch(`/report/${boardNum}`, {
                    method: 'POST'
                });
                const message = await response.text();
                alert(message);
            } catch (error) {
                console.error('신고 처리 중 오류 발생:', error);
                alert('오류가 발생했습니다. 다시 시도해주세요.');
            }
        }

        async function createComment(content) {
            try {
                const response = await fetch(`/comment/${boardNum}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ content: content })
                });

                if (response.ok) {
                    document.getElementById('comment-content').value = '';
                    loadComments();
                } else {
                    console.error('댓글 작성 실패:', response.statusText);
                    alert('댓글 작성에 실패했습니다.');
                }
            } catch (error) {
                console.error('댓글 작성 중 오류 발생:', error);
                alert('오류가 발생했습니다. 다시 시도해주세요.');
            }
        }

        async function loadComments() {
            try {
                const response = await fetch(`/comment/${boardNum}`);
                if (response.ok) {
                    const comments = await response.json();
                    displayComments(comments);
                } else {
                    console.error('댓글 로딩 실패:', response.statusText);
                }
            } catch (error) {
                console.error('댓글 로딩 중 오류 발생:', error);
            }
        }

        async function deleteComment(commentId) {
            if (!confirm('정말 삭제하시겠습니까?')) return;

            try {
                const response = await fetch(`/comment/${commentId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    loadComments();
                } else {
                    console.error('댓글 삭제 실패:', response.statusText);
                    alert('댓글 삭제에 실패했습니다.');
                }
            } catch (error) {
                console.error('댓글 삭제 중 오류 발생:', error);
                alert('오류가 발생했습니다. 다시 시도해주세요.');
            }
        }


        function displayComments(comments) {
            const commentsList = document.getElementById('comments-list');
            commentsList.innerHTML = '';
            if (comments.length === 0) {
                commentsList.innerHTML = '<p>등록된 댓글이 없습니다.</p>';
                return;
            }

            comments.forEach(comment => {
                const commentEl = document.createElement('div');
                commentEl.className = 'card mb-2';
                commentEl.id = `comment-${comment.commentId}`;

                let buttons = '';
                const isAdmin = /*[[${#authorization.expression('hasRole(''ADMIN'')')}]]*/ false;
                if (currentMemberId === comment.memberId || isAdmin) {
                    buttons = `
                        <div class="mt-2">
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteComment(${comment.commentId})">삭제</button>
                        </div>
                    `;
                }

                commentEl.innerHTML = `
                    <div class="card-body">
                        <p class="card-text">${comment.content}</p>
                        <div class="text-muted small">
                            <span>${comment.memberId}</span> |
                            <span>${new Date(comment.createdDate).toLocaleString()}</span>
                        </div>
                        ${buttons}
                    </div>
                `;
                commentsList.appendChild(commentEl);
            });
        }
        /*]]>*/
    </script>
</body>
</html>
