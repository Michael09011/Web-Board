<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title>게시글 수정</title>
    <link rel="stylesheet" href="https://bootswatch.com/5/cosmo/bootstrap.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- CKEditor 5 CDN -->
    <script src="https://cdn.ckeditor.com/ckeditor5/41.0.0/classic/ckeditor.js"></script>

    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
        }
        /* CKEditor 높이 및 이미지 크기 조절 */
        .ck-editor__editable_inline {
            min-height: 300px;
        }
        .ck-content img {
            max-width: 100%;
            height: auto;
            max-height: 600px;
        }
    </style>
</head>
<body>
    <div th:replace="~{header :: header}"></div>
    <div th:replace="~{menu :: menu}"></div>
    <main class="container my-5" style="max-width:600px;">
        <h1 class="text-center mb-4">게시글 수정</h1>
        <form th:action="@{'/board/edit/' + ${board.boardNum}}" th:object="${board}" method="post" enctype="multipart/form-data">
            <div class="mb-3">
                <label for="boardTitle" class="form-label">제목</label>
                <input type="text" class="form-control" id="boardTitle" th:field="*{boardTitle}" required />
            </div>
            <div class="mb-3">
                <label for="boardContent" class="form-label">내용</label>
                <textarea class="form-control" id="boardContent" th:field="*{boardContent}" rows="8"></textarea>
            </div>

            <!-- 기존 첨부파일 목록 및 삭제 -->
            <div class="mt-3" th:if="${not #lists.isEmpty(board.files)}">
                <h5>첨부파일</h5>
                <ul class="list-group">
                    <li class="list-group-item" th:each="file : ${board.files}">
                        <input type="checkbox" name="deleteFileIds" th:value="${file.fileId}" class="form-check-input me-2">
                        <a th:href="@{'/board/download/' + ${file.fileId}}" th:text="${file.originalName}"></a>
                        <span class="text-muted ms-2" th:text="${file.fileSize} + ' bytes'"></span>
                    </li>
                </ul>
                <div class="form-text">삭제를 원하는 파일을 선택하세요.</div>
            </div>

            <!-- 새 파일 첨부 -->
            <div class="mb-3 mt-4">
                <label for="files" class="form-label">파일 추가</label>
                <input type="file" class="form-control" id="files" name="uploadFiles" multiple />
            </div>

            <div class="d-grid gap-2 mt-4">
                <button class="btn btn-primary btn-lg" type="submit">수정 완료</button>
                <a th:href="@{'/board/view/' + ${board.boardNum}}" class="btn btn-secondary btn-lg">취소</a>
            </div>
        </form>
    </main>
    <div th:replace="~{footer :: footer}"></div>

    <script>
        class MyUploadAdapter {
            constructor(loader) {
                this.loader = loader;
            }

            upload() {
                return this.loader.file
                    .then(file => new Promise((resolve, reject) => {
                        const data = new FormData();
                        data.append('file', file);

                        fetch('/board/upload', {
                            method: 'POST',
                            body: data
                        })
                        .then(response => response.json())
                        .then(result => {
                            if (result.url) {
                                resolve({
                                    default: result.url
                                });
                            } else {
                                reject('Upload failed: No URL returned');
                            }
                        })
                        .catch(error => {
                            reject(error);
                        });
                    }));
            }

            abort() {
                // Abort upload
            }
        }

        function MyCustomUploadAdapterPlugin(editor) {
            editor.plugins.get('FileRepository').createUploadAdapter = (loader) => {
                return new MyUploadAdapter(loader);
            };
        }

        ClassicEditor
            .create( document.querySelector( '#boardContent' ), {
                extraPlugins: [ MyCustomUploadAdapterPlugin ],
                // 유튜브, 비메오 등 동영상 삽입을 위한 미디어 임베드 플러그인 추가
                mediaEmbed: {
                    previewsInData: true
                },
                toolbar: {
                    items: [
                        'heading', '|',
                        'bold', 'italic', 'link', 'bulletedList', 'numberedList', 'blockQuote', '|',
                        'uploadImage', // 이미지 업로드 버튼
                        'mediaEmbed',  // 미디어 임베드 버튼 (유튜브 등)
                        'insertTable', '|',
                        'undo', 'redo'
                    ]
                },
                language: 'ko' // 에디터 언어 설정
            } )
            .catch( error => {
                console.error( error );
            } );
    </script>
</body>
</html>
