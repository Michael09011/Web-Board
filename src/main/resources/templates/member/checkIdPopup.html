<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title>아이디 중복 확인</title>
    <link
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
        rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
    <div class="container p-3">
        <h3 class="mb-3">아이디 중복 확인</h3>
        <form id="checkForm" class="d-flex mb-3">
            <input type="text" class="form-control me-2" id="popupMemberId" name="memberId" placeholder="아이디 입력 (4~10자)" required minlength="4" maxlength="10" />
            <button type="submit" class="btn btn-primary">중복 확인</button>
        </form>
        <div id="popupMessage" class="mb-3"></div>
        <div id="buttonGroup" class="d-none">
            <button type="button" class="btn btn-success" id="useBtn">사용하기</button>
            <button type="button" class="btn btn-secondary" id="cancelBtn">취소</button>
        </div>
    </div>
    <script>
        const form = document.getElementById('checkForm');
        const popupMemberId = document.getElementById('popupMemberId');
        const popupMessage = document.getElementById('popupMessage');
        const buttonGroup = document.getElementById('buttonGroup');
        const useBtn = document.getElementById('useBtn');
        const cancelBtn = document.getElementById('cancelBtn');

        // URL에서 csrf 파라미터 추출
        const urlParams = new URLSearchParams(window.location.search);
        const csrfToken = urlParams.get('csrf');

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = popupMemberId.value;
            const response = await fetch('/member/checkId', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRF-TOKEN': csrfToken
                },
                body: `memberId=${id}`
            });
            const isAvailable = await response.json();
            if (isAvailable) {
                popupMessage.textContent = `'${id}'는 사용 가능한 아이디입니다.`;
                popupMessage.style.color = 'green';
                buttonGroup.classList.remove('d-none');
            } else {
                popupMessage.textContent = `'${id}'는 이미 사용 중인 아이디입니다.`;
                popupMessage.style.color = 'red';
                buttonGroup.classList.add('d-none');
            }
        });

        useBtn.addEventListener('click', () => {
            const id = popupMemberId.value;
            window.opener.setMemberId(id);
            window.close();
        });

        cancelBtn.addEventListener('click', () => {
            window.close();
        });
    </script>
</body>
</html>
